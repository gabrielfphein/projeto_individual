const enviarEmail = require('./envia-email.js');
const prompt = require('prompt-sync')();

const listaDeClientes = [];

const novidades = [
    "Carro Modelo eletrico - Recém lançado com autonomia de 500km",
    "Carro Modelo brasileiro - Design inovador e mais espaço interno",
    "Carro Modelo chines - Com tecnologia autônoma de nível 3"
];

const ofertas = [
    "Desconto de 10% no Modelo eletrico para os primeiros 50 compradores",
    "Financiamento em 24x sem juros no Modelo brassileiro",
    "Seguro grátis no primeiro ano para o Modelo chines"
];

function emailEhValido(email) {
    const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regexEmail.test(email);
}

function nomeEhValido(nome) {
    const regexNome = /^[A-Za-z\s]+$/;
    return regexNome.test(nome);
}

function coletarDadosDoCliente() {
    let nome = prompt("Digite o nome do cliente: ");

    while (!nomeEhValido(nome)) {
        console.error("Nome inválido. Por favor, insira um nome sem números ou caracteres especiais.");
        nome = prompt("Digite o nome do cliente novamente: ");
    }

    let email = prompt("Digite o e-mail do cliente: ");

    while (!emailEhValido(email)) {
        console.error("E-mail inválido. Por favor, insira um e-mail válido.");
        email = prompt("Digite o e-mail do cliente novamente: ");
    }

    const aceitaMarketing = prompt("O cliente aceita receber comunicações de marketing? (sim/não): ").toLowerCase() === 'sim';
    listaDeClientes.push({ nome, email, aceitaMarketing });
}

function hojeEhSegundaFeira(segunda) {
    const hoje = new Date();
    return hoje.getDay() === 1;
}

function montarNovidades() {
    return novidades.map(novidade => `• ${novidade}`).join('\n');
}

function montarOfertas() {
    return ofertas.map(oferta => `• ${oferta}`).join('\n');
}

function montarCorpoEmail(nome) {
    return `
        Olá ${nome}!

        Ficamos felizes com sua visita à CarStore no último mês!

        Novidades:
        ${montarNovidades()}

        Ofertas especiais para você:
        ${montarOfertas()}

        Confira essas e outras condições especiais de aquisição que preparamos para você.
        
        Esperamos vê-lo em breve em uma de nossas lojas!

        Atenciosamente,
        Equipe CarStore
    `;
}

function enviarEmailsParaClientes() {
    if (!hojeEhSegundaFeira()) {
        console.log("Hoje não é segunda-feira. Os e-mails serão enviados apenas nas segundas.");
        return;
    }

    for (const cliente of listaDeClientes) {
        if (cliente.aceitaMarketing) {
            const corpoEmail = montarCorpoEmail(cliente.nome);
            const resultado = enviarEmail(cliente.email, "Novidades da CarStore para você", corpoEmail);

            if (resultado.status === "Error") {
                console.error(`Erro ao enviar e-mail para ${cliente.email}. Motivo: ${resultado.message}`);
            } else {
                console.log(`E-mail enviado com sucesso para ${cliente.email}`);
            }
        } else {
            console.log(`O cliente ${cliente.nome} optou por não receber comunicações de marketing.`);
        }
    }
}

// Coleta de dados do cliente e envio do e-mail
coletarDadosDoCliente();
enviarEmailsParaClientes();
